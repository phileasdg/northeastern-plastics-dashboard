<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>NOAA MDMAP API Explorer</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
            <!-- Header -->
            <div class="text-center border-b border-gray-200 dark:border-gray-700 pb-6 mb-6">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">NOAA MDMAP API Explorer</h1>
                <p class="text-gray-600 dark:text-gray-300">Navigate through the marine debris database.</p>
            </div>

            <!-- Controls and Exploration UI -->
            <div id="explorer" class="space-y-6">
                <!-- This will be populated dynamically -->
            </div>

            <!-- Response Viewer -->
            <div class="mt-8">
                <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-200 mb-4">API Response Data</h2>
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 h-96 overflow-y-auto">
                    <pre id="apiResponse" class="text-sm text-gray-800 dark:text-gray-100 whitespace-pre-wrap break-words">Select an endpoint to begin.</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const explorerEl = document.getElementById('explorer');
        const apiResponseEl = document.getElementById('apiResponse');

        // --- State Management ---
        let siteDataCache = null;

        // --- API Configuration ---
        const baseUrl = 'https://portal.diver.orr.noaa.gov/pentaho/mdmap';
        // Using an array of proxies for better reliability. If one fails, the next is used.
        const proxyUrls = [
            'https://api.allorigins.win/raw?url=',
            'https://corsproxy.io/?',
            'https://cors-anywhere.herokuapp.com/' // Rob--W's cors-anywhere proxy
        ];

        // --- Helper Functions ---
        const fetchApi = async (endpoint, retriesPerProxy = 2) => {
            const targetUrl = `${baseUrl}${endpoint}`;
            
            // Iterate through each proxy URL
            for (let p_idx = 0; p_idx < proxyUrls.length; p_idx++) {
                const proxy = proxyUrls[p_idx];
                
                // Adjust how the request URL is constructed based on the proxy
                let requestUrl;
                if (proxy.includes('cors-anywhere')) {
                    requestUrl = proxy + targetUrl; // This proxy doesn't need URL encoding on the whole target
                } else {
                    requestUrl = proxy + encodeURIComponent(targetUrl);
                }
                
                const proxyName = new URL(proxy).hostname; // Get a clean name like 'api.allorigins.win'
                
                // Retry logic for the current proxy
                for (let i = 0; i < retriesPerProxy; i++) {
                    try {
                        // Update UI to show loading/retry state with which proxy is being used
                        let loadingMessage;
                        if (i === 0) {
                            loadingMessage = `Fetching via ${proxyName}...`;
                        } else {
                            loadingMessage = `Retrying via ${proxyName} (Attempt ${i + 1})...`;
                        }
                        apiResponseEl.innerHTML = `<div class="flex justify-center items-center h-full"><div class="flex flex-col items-center"><div class="loader"></div><p class="text-sm mt-2">${loadingMessage}</p></div></div>`;
                        apiResponseEl.classList.remove('text-red-500');

                        const response = await fetch(requestUrl);
                        if (!response.ok) {
                            if (response.status === 429) throw new Error(`Proxy rate limit (Status ${response.status})`);
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        apiResponseEl.textContent = JSON.stringify(data, null, 2);
                        console.log(`Successfully fetched using proxy: ${proxyName}`);
                        return data; // Success! Exit the function.

                    } catch (error) {
                        console.error(`Attempt ${i + 1} with proxy ${proxyName} failed:`, error);
                        if (i < retriesPerProxy - 1) {
                            // Wait a moment before retrying the same proxy
                            await new Promise(res => setTimeout(res, 1000));
                        }
                        // If it's the last retry, the outer loop will proceed to the next proxy
                    }
                }
            }

            // This part is only reached if all proxies and all their retries fail
            apiResponseEl.textContent = `Failed to fetch data after trying all available proxies.\n\nPlease check your network connection or try again later.`;
            apiResponseEl.classList.add('text-red-500');
            return null;
        };

        const createSection = (title) => {
            const section = document.createElement('div');
            section.id = `section-${title.toLowerCase().replace(/[^a-z0-p-]/g, '-')}`;
            section.innerHTML = `<h3 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2">${title}</h3>`;
            const listContainer = document.createElement('div');
            listContainer.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2';
            section.appendChild(listContainer);
            return section;
        };
        
        const createClickableItem = (text, onClick) => {
            const button = document.createElement('button');
            button.textContent = text;
            button.className = 'w-full text-left p-2 bg-gray-100 dark:bg-gray-700 hover:bg-blue-100 dark:hover:bg-blue-900 rounded-md text-sm transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500';
            button.addEventListener('click', onClick);
            return button;
        };

        const clearSections = (fromLevel) => {
            const levels = ['sites', 'surveys', 'transects', 'debris'];
            const startIndex = levels.indexOf(fromLevel);
            if (startIndex === -1) return;
            for (let i = startIndex; i < levels.length; i++) {
                const section = document.getElementById(`section-${levels[i]}`);
                if (section) section.remove();
            }
        };


        // --- Render Functions ---
        const renderInitialView = () => {
            explorerEl.innerHTML = '';
            const initialSection = createSection('Endpoints');
            const listContainer = initialSection.querySelector('div');
            
            listContainer.appendChild(createClickableItem('All Sites', handleFetchSites));
            listContainer.appendChild(createClickableItem('All Groups', () => fetchApi('/groups')));
            
            explorerEl.appendChild(initialSection);
        };

        const renderSiteList = (sites) => {
            clearSections('sites');
            const sitesSection = createSection('Sites');
            const listContainer = sitesSection.querySelector('div');
            
            sites.forEach(site => {
                const item = createClickableItem(`${site.name} (ID: ${site.id})`, () => handleSiteClick(site));
                listContainer.appendChild(item);
            });
            explorerEl.appendChild(sitesSection);
        };
        
        const renderSurveyList = (site) => {
            clearSections('surveys');
            if (!site.surveys || site.surveys.length === 0) {
                 const surveysSection = createSection(`Surveys for ${site.name}`);
                 surveysSection.querySelector('div').innerHTML = `<p class="col-span-full text-gray-500 italic">No surveys found for this site.</p>`;
                 explorerEl.appendChild(surveysSection);
                return;
            }

            const surveysSection = createSection(`Surveys for ${site.name}`);
            const listContainer = surveysSection.querySelector('div');
            
            site.surveys.forEach(surveyId => {
                const item = createClickableItem(`Survey ID: ${surveyId}`, () => handleSurveyClick(surveyId));
                listContainer.appendChild(item);
            });
            explorerEl.appendChild(surveysSection);
        };
        
        const renderTransectList = (survey) => {
            clearSections('transects');
            if (!survey.transects || survey.transects.length === 0) {
                const transectsSection = createSection(`Transects for Survey ${survey.id}`);
                transectsSection.querySelector('div').innerHTML = `<p class="col-span-full text-gray-500 italic">No transects found for this survey.</p>`;
                explorerEl.appendChild(transectsSection);
                return;
            }

            const transectsSection = createSection(`Transects for Survey ${survey.id}`);
            const listContainer = transectsSection.querySelector('div');

            survey.transects.forEach(transectId => {
                const item = createClickableItem(`Transect ID: ${transectId}`, () => handleTransectClick(transectId));
                listContainer.appendChild(item);
            });
            explorerEl.appendChild(transectsSection);
        };

        const renderDebrisList = (transect) => {
            clearSections('debris');
             if (!transect.debris || transect.debris.length === 0) {
                const debrisSection = createSection(`Debris for Transect ${transect.id}`);
                debrisSection.querySelector('div').innerHTML = `<p class="col-span-full text-gray-500 italic">No debris found for this transect.</p>`;
                explorerEl.appendChild(debrisSection);
                return;
            }

            const debrisSection = createSection(`Debris for Transect ${transect.id}`);
            const listContainer = debrisSection.querySelector('div');

            transect.debris.forEach(debrisId => {
                const item = createClickableItem(`Debris ID: ${debrisId}`, () => fetchApi(`/debris/${debrisId}`));
                listContainer.appendChild(item);
            });
            explorerEl.appendChild(debrisSection);
        };

        // --- Event Handlers ---
        const handleFetchSites = async () => {
            const data = await fetchApi('/sites');
            if (data) {
                siteDataCache = data; // Cache the data
                renderSiteList(data);
            }
        };

        const handleSiteClick = (site) => {
            apiResponseEl.textContent = JSON.stringify(site, null, 2);
            renderSurveyList(site);
        };
        
        const handleSurveyClick = async (surveyId) => {
            const data = await fetchApi(`/surveys/${surveyId}`);
            if (data) renderTransectList(data);
        };

        const handleTransectClick = async (transectId) => {
            const data = await fetchApi(`/transects/${transectId}`);
            if (data) renderDebrisList(data);
        };


        // --- Initial Load ---
        renderInitialView();
    </script>

</body>
</html>